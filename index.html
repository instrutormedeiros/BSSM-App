<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#005eb8" />
    <title>BSSM Portal | Hospital Santa Marta</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { 
              sans: ['Inter', 'sans-serif'], 
              heading: ['"Plus Jakarta Sans"', 'sans-serif'],
              poppins: ['Poppins', 'sans-serif']
            },
            colors: {
              hsm: { 
                blue: '#005eb8', 
                dark: '#003d7a', 
                cyan: '#00a896', 
                light: '#e6f0fa',
                surface: '#f8fafc',
                purple: '#6366f1'
              }
            },
            boxShadow: {
              'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
              'card': '0 10px 40px -10px rgba(0,0,0,0.08)',
              'logo-glow': '0 0 25px -5px rgba(0, 94, 184, 0.15), 0 10px 25px -5px rgba(0, 94, 184, 0.15)' 
            },
            animation: {
              'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
              'slide-up': 'slideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1)',
              'scale-in': 'scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
              'pulse-soft': 'pulseSoft 3s infinite',
              'blob': 'blob 7s infinite',
              'pulse-glow': 'pulseGlow 4s ease-in-out infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
              pulseSoft: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
              blob: {
                "0%": { transform: "translate(0px, 0px) scale(1)" },
                "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                "100%": { transform: "translate(0px, 0px) scale(1)" }
              },
              pulseGlow: {
                "0%, 100%": { boxShadow: '0 0 20px -5px rgba(0, 94, 184, 0.1), 0 10px 15px -5px rgba(0, 94, 184, 0.1)' },
                "50%": { boxShadow: '0 0 35px -5px rgba(0, 94, 184, 0.25), 0 20px 30px -10px rgba(0, 94, 184, 0.2)' }
              }
            }
          },
        },
      }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      
      .glass {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      
      .doc-card {
          background: #ffffff;
          border-radius: 16px;
          box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
          position: relative;
          overflow: hidden;
          background-image: radial-gradient(rgba(0, 94, 184, 0.1) 0.5px, transparent 0.5px), radial-gradient(rgba(0, 94, 184, 0.1) 0.5px, #ffffff 0.5px);
          background-size: 20px 20px;
          background-position: 0 0, 10px 10px;
          background-color: #fcfcfc;
      }
      
      .doc-header {
          background: linear-gradient(90deg, #005eb8 0%, #003d7a 100%);
          color: white;
          position: relative;
          overflow: hidden;
      }
      .doc-header::after {
          content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
          background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }

      .photo-frame {
          width: 110px; height: 110px;
          background-color: #e2e8f0; border: 4px solid #fff;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          border-radius: 12px; overflow: hidden; position: relative;
          cursor: pointer; transition: all 0.3s ease;
      }
      .photo-frame:hover { border-color: #00a896; transform: scale(1.02); }
      .photo-frame:active { transform: scale(0.98); }
      .photo-overlay {
          position: absolute; inset: 0; background: rgba(0,0,0,0.3);
          display: flex; align-items: center; justify-content: center;
          opacity: 0; transition: opacity 0.2s;
      }
      .photo-frame:hover .photo-overlay { opacity: 1; }

      body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
    <script type="module">
      // Importando os m√≥dulos essenciais do Firebase v10.8.1
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

      // Suas credenciais exclusivas
      const firebaseConfig = {
        apiKey: "AIzaSyAk3bwFb7ROhsR5Cu3YXdo3e_n6KHI9xmA",
        authDomain: "bssm---app.firebaseapp.com",
        databaseURL: "https://bssm---app-default-rtdb.firebaseio.com",
        projectId: "bssm---app",
        storageBucket: "bssm---app.firebasestorage.app",
        messagingSenderId: "875637451285",
        appId: "1:875637451285:web:132da6ecd7f3f7343c7c1c"
      };

      // Inicializa o app e o banco de dados
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Exportando para o escopo global para o React/Babel poder usar
      window.firebaseDB = db;
      window.firebaseSetDoc = setDoc;
      window.firebaseGetDoc = getDoc;
      window.firebaseDoc = doc;
      
      console.log("üî• Firebase Bridge inicializado com sucesso!");
    </script>
  </head>
  <body class="bg-hsm-surface text-slate-800 antialiased overflow-x-hidden selection:bg-hsm-blue selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      // Acessando globais
      const { useState, useEffect, useRef, useMemo } = React;
      // AS LINHAS QUE CAUSAVAM O ERRO FORAM REMOVIDAS DAQUI
      // Agora usamos window.XLSX e window.ReactDOM diretamente

      // --- √çCONES (ADAPTADOS DE LUCIDE PARA FONTAWESOME) ---
      
      const IconBase = ({ icon, size = 20, className = "", strokeWidth }) => (
        <i className={`fa-solid ${icon} ${className}`} style={{ fontSize: size }}></i>
      );

      const LogOut = (p) => <IconBase icon="fa-right-from-bracket" {...p} />;
      const User = (p) => <IconBase icon="fa-user" {...p} />; 
      const UserIcon = User;
      const UploadCloud = (p) => <IconBase icon="fa-cloud-arrow-up" {...p} />;
      const Trash2 = (p) => <IconBase icon="fa-trash-can" {...p} />;
      const Search = (p) => <IconBase icon="fa-magnifying-glass" {...p} />;
      const FileSpreadsheet = (p) => <IconBase icon="fa-file-excel" {...p} />;
      const Lock = (p) => <IconBase icon="fa-lock" {...p} />;
      const UserCheck = (p) => <IconBase icon="fa-user-check" {...p} />;
      const ArrowRight = (p) => <IconBase icon="fa-arrow-right" {...p} />;
      const AlertCircle = (p) => <IconBase icon="fa-circle-exclamation" {...p} />;
      const RefreshCw = (p) => <IconBase icon="fa-rotate" {...p} />;
      const ShieldCheck = (p) => <IconBase icon="fa-shield-halved" {...p} />;
      const LayoutDashboard = (p) => <IconBase icon="fa-table-columns" {...p} />;
      const FileText = (p) => <IconBase icon="fa-file-lines" {...p} />;
      const Eye = (p) => <IconBase icon="fa-eye" {...p} />;
      const XCircle = (p) => <IconBase icon="fa-circle-xmark" {...p} />;


      // --- TYPES & CONSTANTS ---
      const UserRole = {
        ADMIN: 'admin',
        CONSULTA: 'consulta', 
        USER: 'user'
      };

      const EligibilityStatus = {
        OK: 'ok',
        WARNING: 'warning',
        ERROR: 'error'
      };

      // --- SERVICES ---
      const KEYS = {
        AUTH: 'bssm_auth_v7',
        DB: 'bssm_db_v7',
        PHOTOS: 'bssm_photos_v1'
      };

      const storageService = {
        getSession: () => {
          try {
            const data = localStorage.getItem(KEYS.AUTH);
            return data ? JSON.parse(data) : null;
          } catch { return null; }
        },
        setSession: (user) => localStorage.setItem(KEYS.AUTH, JSON.stringify(user)),
        clearSession: () => localStorage.removeItem(KEYS.AUTH),
        
        getData: () => {
          try {
            const db = localStorage.getItem(KEYS.DB);
            return db ? JSON.parse(db) : null;
          } catch { return null; }
        },
        setData: (data) => {
          const payload = {
            data,
            date: new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
          };
          localStorage.setItem(KEYS.DB, JSON.stringify(payload));
        },
        clearData: () => localStorage.removeItem(KEYS.DB),

        getPhoto: (id) => {
          try {
            const photos = JSON.parse(localStorage.getItem(KEYS.PHOTOS) || '{}');
            return photos[id] || null;
          } catch { return null; }
        },
        setPhoto: (id, base64) => {
          try {
            const photos = JSON.parse(localStorage.getItem(KEYS.PHOTOS) || '{}');
            photos[id] = base64;
            localStorage.setItem(KEYS.PHOTOS, JSON.stringify(photos));
            return true;
          } catch (e) {
            console.error("Storage full", e);
            return false;
          }
        }
      };

      // --- UTILS ---
      const parseExcelDate = (value) => {
        if (!value) return '';
        if (typeof value === 'number') {
          const date = new Date(Math.round((value - 25569) * 86400 * 1000));
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString('pt-BR');
          }
        }
        return String(value).trim();
      };

      const analyzeStatus = (text) => {
        if (!text) return EligibilityStatus.WARNING;
        const s = text.toString().toUpperCase().trim();
        if (s.includes('SEM CAR√äNCIA') || s.includes('CONCEDIDO AT√â') || s.includes('ELEG√çVEL') || s.includes('ATIVO') || s.includes('OK')) {
          return EligibilityStatus.OK;
        }
        if (s.includes('SUSPENSO') || s.includes('PROCURE O RH') || s.includes('INAPTO') || s.includes('CANCELADO') || s.includes('DESLIGADO')) {
          return EligibilityStatus.ERROR;
        }
        return EligibilityStatus.WARNING;
      };

      const parseExcelFile = async (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = window.XLSX.read(data, { type: 'array' }); // Usando window.XLSX
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const json = window.XLSX.utils.sheet_to_json(worksheet, { defval: '' }); // Usando window.XLSX

              const normalizedData = json.map((row) => {
                const getVal = (keys) => {
                  for (const k of Object.keys(row)) {
                    if (keys.some(key => k.trim().toLowerCase() === key.toLowerCase())) return row[k];
                  }
                  return '';
                };
                return {
                  matricula: String(getVal(['Matr√≠cula', 'Matricula', 'MATRICULA', 'ID'])).trim(),
                  nome: String(getVal(['Nome', 'NOME', 'Colaborador'])).trim(),
                  local: String(getVal(['Local', 'LOCAL', 'Setor'])).trim(),
                  admissao: parseExcelDate(getVal(['Admiss√£o', 'Admissao', 'ADMISS√ÉO'])),
                  situacao: String(getVal(['Situa√ß√£o Atual', 'Situacao Atual', 'Situa√ß√£o', 'Status'])).trim(),
                  nascimento: parseExcelDate(getVal(['Data Nascimento', 'Nascimento', 'DT NASC'])),
                  cpf: String(getVal(['CPF', 'cpf', 'Doc'])).trim(),
                  elegibilidade: parseExcelDate(getVal(['Elegibilidade', 'Status Beneficio', 'ELEGIVEL'])),
                  cargo: String(getVal(['Cargo', 'Fun√ß√£o'])).trim() 
                };
              }).filter(item => item.matricula && item.nome);
              resolve(normalizedData);
            } catch (error) { reject(error); }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      };

      // --- UI COMPONENTS ---

      const Header = ({ user, onLogout }) => {
        const getRoleBadge = () => {
          if (user.role === UserRole.ADMIN) return { color: 'bg-hsm-blue', text: 'Administrador', pulse: true };
          if (user.role === UserRole.CONSULTA) return { color: 'bg-hsm-purple', text: 'Consultor', pulse: false };
          return { color: 'bg-hsm-cyan', text: 'Colaborador', pulse: false };
        };
        const badge = getRoleBadge();

        return (
          <header className="sticky top-0 z-50 w-full glass shadow-sm transition-all duration-300">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-20">
                <div className="flex items-center gap-4 group cursor-default">
                  <div className="bg-hsm-blue/5 p-2.5 rounded-2xl group-hover:bg-hsm-blue/10 transition-colors duration-300">
                    <img src="https://raw.githubusercontent.com/instrutormedeiros/IndicadoresBrigadaHSM/refs/heads/main/assets/LOGO%20HSM.png" alt="HSM" className="h-9 w-auto" />
                  </div>
                  <div className="hidden md:block w-px h-10 bg-gradient-to-b from-transparent via-slate-300 to-transparent mx-1"></div>
                  <div className="flex flex-col">
                    <h1 className="font-heading text-xl font-bold text-slate-800 leading-none tracking-tight">
                      Portal <span className={user.role === UserRole.ADMIN ? "text-hsm-blue" : (user.role === UserRole.CONSULTA ? "text-hsm-purple" : "text-hsm-cyan")}>BSSM</span>
                    </h1>
                    <p className="text-[11px] text-slate-500 font-medium tracking-wider uppercase mt-1">Gest√£o de Benef√≠cios</p>
                  </div>
                </div>

                <div className="flex items-center gap-5">
                  <div className="hidden sm:flex flex-col items-end">
                    <span className="text-sm font-bold text-slate-700">{user.name}</span>
                    <div className="flex items-center gap-1.5">
                      <span className={`w-2 h-2 rounded-full ${badge.color} ${badge.pulse ? 'animate-pulse-soft' : ''}`}></span>
                      <span className="text-[10px] font-bold uppercase text-slate-400 tracking-wide">
                        {badge.text}
                      </span>
                    </div>
                  </div>
                  
                  <button 
                    onClick={onLogout} 
                    className="group relative w-11 h-11 rounded-2xl flex items-center justify-center bg-slate-50 text-slate-500 border border-slate-200 hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-all duration-300 shadow-sm active:scale-95"
                    title="Sair"
                  >
                    <LogOut size={18} className="group-hover:-translate-x-0.5 transition-transform" />
                  </button>
                </div>
              </div>
            </div>
          </header>
        );
      };

      // --- NOVA CARTEIRINHA DIGITAL ---
      const DigitalId = ({ data }) => {
        const [photo, setPhoto] = useState(storageService.getPhoto(data.matricula));
        const fileInputRef = useRef(null);

        const statusType = analyzeStatus(data.elegibilidade);
        
        const config = {
          [EligibilityStatus.OK]: { 
            text: 'ELEG√çVEL', 
            color: 'bg-green-600', 
            icon: 'fa-check-circle' 
          },
          [EligibilityStatus.WARNING]: { 
            text: 'EM AN√ÅLISE', 
            color: 'bg-amber-500', 
            icon: 'fa-clock' 
          },
          [EligibilityStatus.ERROR]: { 
            text: 'INAPTO', 
            color: 'bg-red-500', 
            icon: 'fa-ban' 
          },
        }[statusType];

        const handlePhotoUpload = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          if (file.size > 5 * 1024 * 1024) return alert("A imagem deve ter no m√°ximo 5MB.");

          const reader = new FileReader();
          reader.onload = (ev) => {
            const img = new Image();
            img.src = ev.target.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const MAX = 500;
              let { width, height } = img;
              
              if (width > height) { 
                if (width > MAX) { height *= MAX / width; width = MAX; }
              } else {
                if (height > MAX) { width *= MAX / height; height = MAX; }
              }
              
              canvas.width = width; canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              const base64 = canvas.toDataURL('image/jpeg', 0.85);
              if (storageService.setPhoto(data.matricula, base64)) setPhoto(base64);
              else alert("Erro de armazenamento local (Limite excedido).");
            }
          };
          reader.readAsDataURL(file);
        };

        return (
          <div className="flex flex-col items-center justify-center py-8 px-4 w-full animate-slide-up">
             <div className="doc-card w-full max-w-[420px] mx-auto shadow-2xl">
                
                {/* Header Azul com Logos */}
                <div className="doc-header p-4 flex justify-between items-center">
                    <img src="https://raw.githubusercontent.com/instrutormedeiros/IndicadoresBrigadaHSM/refs/heads/main/assets/LOGO%20HSM.png" className="h-8 brightness-0 invert opacity-90" alt="HSM Logo" />
                    <div className="text-right z-10">
                        <h3 className="text-[9px] font-bold uppercase tracking-widest opacity-80 text-white">Identidade Digital</h3>
                        <p className="text-xs font-bold text-white">BSSM</p>
                    </div>
                </div>

                {/* Corpo do Cart√£o */}
                <div className="p-6">
                    
                    {/* Linha da Foto e Nome */}
                    <div className="flex gap-5 mb-6">
                        {/* Moldura da Foto */}
                        <div className="photo-frame flex-shrink-0" onClick={() => fileInputRef.current?.click()}>
                            {photo ? (
                                <img src={photo} className="w-full h-full object-cover" alt="Perfil" />
                            ) : (
                                <div className="w-full h-full bg-slate-200 flex flex-col items-center justify-center text-slate-400">
                                    <i className="fa-solid fa-camera text-3xl"></i>
                                    <span className="text-[8px] uppercase mt-1 font-bold">Foto</span>
                                </div>
                            )}
                            <div className="photo-overlay">
                                <i className="fa-solid fa-pen text-white text-lg drop-shadow-md"></i>
                            </div>
                        </div>
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handlePhotoUpload} />

                        {/* Informa√ß√µes Principais */}
                        <div className="flex-1 flex flex-col justify-center">
                            <h2 className="text-xl font-bold text-slate-800 leading-tight uppercase font-poppins">{data.nome}</h2>
                            <p className="text-[10px] text-slate-500 font-bold uppercase mt-1">Cargo / Fun√ß√£o</p>
                            <p className="text-sm font-semibold text-hsm-blue uppercase">{data.cargo || 'N√£o informado'}</p>
                        </div>
                    </div>

                    {/* Grid de Dados Secund√°rios - 3 COLUNAS */}
                    <div className="grid grid-cols-3 gap-3 mb-6">
                        <div className="bg-slate-50 p-2 rounded border border-slate-100">
                            <span className="text-[9px] text-slate-400 font-bold uppercase block">Matr√≠cula</span>
                            <span className="text-sm font-mono font-bold text-slate-700">{data.matricula}</span>
                        </div>
                        <div className="bg-slate-50 p-2 rounded border border-slate-100">
                            <span className="text-[9px] text-slate-400 font-bold uppercase block">Situa√ß√£o</span>
                            <span className="text-xs font-bold text-slate-700 truncate block">{data.situacao}</span>
                        </div>
                        <div className="bg-slate-50 p-2 rounded border border-slate-100">
                            <span className="text-[9px] text-slate-400 font-bold uppercase block">Local</span>
                            <span className="text-xs font-bold text-slate-700 truncate block" title={data.local}>{data.local}</span>
                        </div>
                    </div>
                    
                    {/* √Årea de Status e A√ß√µes */}
                    <div className="border-t-2 border-dashed border-slate-200 pt-4 flex justify-between items-end gap-2 relative">
                        
                        {/* Status do Benef√≠cio */}
                        <div className="flex flex-col gap-2">
                            <span className="text-[10px] text-slate-500 font-bold uppercase block tracking-wide">Situa√ß√£o Cadastral</span>
                            <span className={`${config.color} text-white px-3 py-1.5 rounded-md text-xs sm:text-sm font-black uppercase tracking-wide shadow-md flex items-center gap-2 w-max transform hover:scale-105 transition-transform`}>
                                <i className={`fa-solid ${config.icon} text-sm`}></i> {config.text}
                            </span>
                            <p className="text-[9px] text-slate-400 mt-1 max-w-[130px] leading-tight font-medium">
                                V√°lido mediante apresenta√ß√£o de documento oficial.
                            </p>
                        </div>
                        
                        {/* Links Externos */}
                        <div className="flex flex-col gap-3 items-end relative mt-2 w-full max-w-[170px]">
                            {/* Anima√ß√£o "Consulte Aqui" */}
                            <div className="absolute -top-9 right-0 flex flex-col items-end animate-bounce z-20 pointer-events-none">
                                <span className="text-[9px] font-bold text-white bg-hsm-blue px-2 py-1 rounded shadow-lg whitespace-nowrap border border-blue-400">Consulte Aqui</span>
                                <i className="fa-solid fa-caret-down text-hsm-blue text-lg -mt-1.5 mr-4 drop-shadow-sm"></i>
                            </div>

                            <a href="https://docs.google.com/spreadsheets/d/1EG4rAXs_hVMTn9hWh4_54uymBziVn_Q7HW3lfdODam8/edit?usp=sharing" target="_blank" className="flex items-center gap-2 bg-blue-50 hover:bg-blue-100 text-hsm-blue px-3 py-2 rounded-lg text-[9px] font-bold uppercase transition-all shadow-sm border border-blue-200 hover:border-blue-300 text-right leading-tight group w-full justify-end active:scale-95">
                                <div>
                                    <span className="block group-hover:underline">Rede Credenciada &</span>
                                    <span className="block group-hover:underline">Taxa de Utiliza√ß√£o</span>
                                </div>
                                <div className="bg-white p-1.5 rounded-full shadow-sm flex-shrink-0"><i className="fa-solid fa-map-location-dot text-sm"></i></div>
                            </a>
                            
                            <a href="https://drive.google.com/file/d/1gOaJJTTl9Pa9TcpFjVMatlhx__uM_Vae/view?usp=drive_link" target="_blank" className="flex items-center gap-2 bg-teal-50 hover:bg-teal-100 text-hsm-cyan px-3 py-2 rounded-lg text-[9px] font-bold uppercase transition-all shadow-sm border border-teal-200 hover:border-teal-300 w-full justify-end group active:scale-95">
                                <span className="group-hover:underline">Sua Cartilha</span>
                                <div className="bg-white p-1.5 rounded-full shadow-sm flex-shrink-0"><i className="fa-solid fa-book-medical text-sm"></i></div>
                            </a>
                        </div>
                    </div>
                </div>
                {/* Faixa decorativa inferior */}
                <div className="bg-hsm-cyan h-1.5 w-full"></div>
             </div>
             
             <div className="mt-8 text-center text-slate-400 text-xs animate-fade-in">
                <p><i className="fa-solid fa-circle-info mr-1"></i> Toque na foto para atualizar sua imagem.</p>
                <p className="mt-1">Apresente este documento digital na rede credenciada.</p>
             </div>
          </div>
        );
      };

      const AdminPanel = ({ user, data, lastUpdated, onDataUpdate, onClearData }) => {
        const [filterText, setFilterText] = useState('');
        const [isUploading, setIsUploading] = useState(false);
        
        const isReadOnly = user.role === UserRole.CONSULTA;

        const stats = useMemo(() => {
          let eligible = 0, ineligible = 0;
          data.forEach(d => {
             const s = analyzeStatus(d.elegibilidade);
             if (s === EligibilityStatus.OK) eligible++; else ineligible++;
          });
          return { total: data.length, eligible, ineligible, lastUpdated };
        }, [data, lastUpdated]);

        const filteredData = useMemo(() => data.filter(item => {
          const s = filterText.toLowerCase();
          return item.nome.toLowerCase().includes(s) || item.matricula.includes(s) || (item.cpf && item.cpf.includes(s)) || item.local.toLowerCase().includes(s);
        }), [data, filterText]);

        const handleFile = async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          setIsUploading(true);
          try {
            const parsed = await parseExcelFile(file);
            storageService.setData(parsed);
            onDataUpdate(parsed);
            alert(`${parsed.length} registros importados com sucesso!`);
          } catch (err) { alert("Erro ao processar o arquivo. Verifique o formato."); }
          finally { setIsUploading(false); e.target.value = ''; }
        };

        const StatCard = ({ label, value, color, icon: Icon, sub }) => (
          <div className={`bg-white p-5 rounded-[24px] border border-slate-100 shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 group relative overflow-hidden`}>
            <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity ${color}`}>
              <Icon size={48} />
            </div>
            <div className="relative z-10">
              <p className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2">{label}</p>
              <div className="flex items-baseline gap-2">
                <p className="text-3xl font-heading font-bold text-slate-800">{value}</p>
              </div>
              {sub && <p className={`text-xs font-medium mt-2 ${color.replace('text-', 'bg-').replace('600', '100')} inline-block px-2 py-0.5 rounded-lg text-slate-600`}>{sub}</p>}
            </div>
            <div className={`h-1 absolute bottom-0 left-4 right-4 rounded-t-full ${color.replace('text', 'bg')}`}></div>
          </div>
        );

        return (
          <div className="space-y-8 pb-12 animate-fade-in w-full">
             {/* Dashboard Header */}
             <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                <div>
                  <h2 className="text-3xl font-heading font-bold text-slate-800 flex items-center gap-3">
                    <LayoutDashboard className={isReadOnly ? "text-hsm-purple" : "text-hsm-blue"} size={32}/> 
                    {isReadOnly ? "Painel de Consulta" : "Painel de Gest√£o"}
                  </h2>
                  <p className="text-slate-500 mt-1">
                    {isReadOnly ? "Visualiza√ß√£o da base de benefici√°rios" : "Vis√£o geral e controle da base de benefici√°rios"}
                  </p>
                </div>
                {!isReadOnly && data.length > 0 && (
                  <button onClick={() => confirm("Tem certeza que deseja apagar todos os dados?") && onClearData()} 
                    className="flex items-center gap-2 px-4 py-2.5 bg-white border border-rose-200 text-rose-600 font-bold rounded-xl hover:bg-rose-50 hover:border-rose-300 transition-all shadow-sm active:scale-95 text-xs uppercase tracking-wide">
                    <Trash2 size={16}/> Limpar Base
                  </button>
                )}
             </div>

             {/* Stats Grid */}
             <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatCard label="Colaboradores" value={stats.total} color={isReadOnly ? "text-hsm-purple" : "text-hsm-blue"} icon={UserIcon} />
                <StatCard label="Eleg√≠veis" value={stats.eligible} color="text-emerald-500" icon={ShieldCheck} />
                <StatCard label="Aten√ß√£o/Inaptos" value={stats.ineligible} color="text-rose-500" icon={AlertCircle} />
                
                <div className={`bg-gradient-to-br ${isReadOnly ? 'from-hsm-purple to-indigo-900' : 'from-hsm-blue to-hsm-dark'} text-white p-5 rounded-[24px] shadow-lg shadow-hsm-blue/20 relative overflow-hidden group`}>
                  <div className="relative z-10 h-full flex flex-col justify-between">
                    <div>
                      <p className="text-[11px] font-bold opacity-70 uppercase tracking-wider mb-1">√öltima Atualiza√ß√£o</p>
                      <p className="text-lg font-bold">{stats.lastUpdated}</p>
                    </div>
                    {!isReadOnly && (
                      <label className="mt-4 flex items-center justify-center w-full py-3 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-xl cursor-pointer transition-all active:scale-95">
                        <span className="text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                          {isUploading ? <RefreshCw className="animate-spin" size={16}/> : <UploadCloud size={16}/>} 
                          {isUploading ? 'Processando...' : 'Importar Base'}
                        </span>
                        <input type="file" className="hidden" accept=".xlsx,.xls" onChange={handleFile} disabled={isUploading} />
                      </label>
                    )}
                  </div>
                  <div className="absolute top-[-20%] right-[-10%] w-32 h-32 bg-white/10 rounded-full blur-2xl group-hover:blur-3xl transition-all"></div>
                </div>
             </div>

             {/* Data Table */}
             <div className="bg-white rounded-[32px] shadow-card border border-slate-100 overflow-hidden flex flex-col">
               <div className="p-6 border-b border-slate-100 bg-slate-50/30 flex flex-col sm:flex-row justify-between gap-4 items-center">
                 <h3 className="font-heading font-bold text-lg text-slate-700 flex items-center gap-2">
                   <FileText size={20} className="text-slate-400"/> Registros
                 </h3>
                 <div className="relative w-full sm:w-72 group">
                   <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none transition-colors group-focus-within:text-hsm-blue text-slate-400">
                     <Search size={18}/>
                   </div>
                   <input 
                    type="text" 
                    className="bg-white border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-2 focus:ring-hsm-blue/20 focus:border-hsm-blue block w-full pl-10 pr-4 py-2.5 outline-none transition-all shadow-sm group-hover:border-slate-300" 
                    placeholder="Buscar colaborador, matr√≠cula..." 
                    value={filterText} 
                    onChange={e => setFilterText(e.target.value)} 
                   />
                 </div>
               </div>

               {filteredData.length === 0 ? (
                 <div className="p-16 text-center flex flex-col items-center justify-center text-slate-400">
                   <div className="bg-slate-50 p-6 rounded-full mb-4 animate-pulse">
                    <FileSpreadsheet size={48} className="opacity-30"/>
                   </div>
                   <p className="font-medium text-slate-500">Nenhum registro encontrado</p>
                   <p className="text-sm mt-1">
                     {isReadOnly ? "Tente refinar sua busca." : "Fa√ßa upload de uma planilha ou refine sua busca."}
                   </p>
                 </div>
               ) : (
                 <div className="overflow-x-auto custom-scrollbar">
                   <table className="w-full text-xs text-left text-slate-500">
                     <thead className="text-[10px] text-slate-500 uppercase font-bold bg-slate-50/80 sticky top-0 backdrop-blur-sm z-10">
                       <tr>
                         <th className="px-6 py-4 tracking-wider">Matr√≠cula</th>
                         <th className="px-6 py-4 tracking-wider">Nome do Colaborador</th>
                         <th className="px-6 py-4 tracking-wider">Local/Setor</th>
                         <th className="px-6 py-4 tracking-wider">Admiss√£o</th>
                         <th className="px-6 py-4 tracking-wider">Situa√ß√£o</th>
                         <th className="px-6 py-4 tracking-wider">CPF</th>
                         <th className="px-6 py-4 tracking-wider text-center">Status</th>
                       </tr>
                     </thead>
                     <tbody className="divide-y divide-slate-100">
                       {filteredData.map((item, i) => {
                         const statusType = analyzeStatus(item.elegibilidade);
                         
                         let statusClass = '';
                         if (statusType === EligibilityStatus.OK) {
                           statusClass = 'bg-emerald-100 text-emerald-700 border-emerald-200';
                         } else if (statusType === EligibilityStatus.ERROR) {
                           statusClass = 'bg-rose-100 text-rose-700 border-rose-200';
                         } else {
                           statusClass = 'bg-amber-100 text-amber-800 border-amber-200';
                         }
                           
                         return (
                           <tr key={i} className="bg-white hover:bg-slate-50 transition-colors group">
                             <td className="px-6 py-3.5 font-mono font-medium text-slate-400 group-hover:text-hsm-blue transition-colors">{item.matricula}</td>
                             <td className="px-6 py-3.5 font-bold text-slate-700 text-sm">{item.nome}</td>
                             <td className="px-6 py-3.5">{item.local}</td>
                             <td className="px-6 py-3.5">{item.admissao}</td>
                             <td className="px-6 py-3.5">{item.situacao}</td>
                             <td className="px-6 py-3.5 font-mono">{item.cpf}</td>
                             <td className="px-6 py-3.5 text-center">
                               <span className={`inline-flex items-center px-2.5 py-1 rounded-md border text-[10px] font-bold uppercase tracking-wide ${statusClass}`}>
                                 {item.elegibilidade}
                               </span>
                             </td>
                           </tr>
                         )
                       })}
                     </tbody>
                   </table>
                 </div>
               )}
               <div className="bg-slate-50 px-6 py-3 border-t border-slate-100 text-[10px] text-slate-400 font-medium flex justify-between">
                  <span>Exibindo {filteredData.length} registros</span>
                  <span>BSSM Database</span>
               </div>
             </div>
          </div>
        );
      };

      const Login = ({ onLogin }) => {
        const [id, setId] = useState('');
        const [pass, setPass] = useState('');
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');

        const formatCPF = (v) => v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').replace(/(-\d{2})\d+?$/, '$1');

        const handleChange = (e) => {
          const val = e.target.value;
          if (/[a-zA-Z]/.test(val)) setId(val);
          else setId(formatCPF(val));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          setLoading(true); setError('');
          setTimeout(() => {
             const clean = id.replace(/\D/g, '');
             const idLower = id.toLowerCase();
             
             if (idLower === 'admin' && pass === 'admin') {
               onLogin({ id: 'admin', name: 'Gestor Administrativo', role: UserRole.ADMIN });
             } 
             else if (idLower === 'consulta' && pass === 'consulta') {
               onLogin({ id: 'consulta', name: 'Perfil Consulta', role: UserRole.CONSULTA });
             }
             else if (pass.length >= 4 && clean.length === 11) {
               onLogin({ id, name: 'Colaborador', role: UserRole.USER, matricula: clean });
             } 
             else { 
               setError('Credenciais inv√°lidas. Verifique os dados inseridos.'); 
               setLoading(false); 
             }
          }, 1000);
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-[#f0f4f8] p-4 relative overflow-hidden">
            {/* Background Decoration */}
            <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
              <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-hsm-blue/10 rounded-full blur-[100px] animate-blob"></div>
              <div style={{ animationDelay: '2s' }} className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-hsm-cyan/10 rounded-full blur-[100px] animate-blob"></div>
            </div>

            <div className="w-full max-w-[420px] bg-white/80 backdrop-blur-xl rounded-[40px] shadow-[0_40px_80px_-20px_rgba(0,0,0,0.1)] border border-white p-10 animate-scale-in relative z-10">
               
               <div className="flex flex-col items-center mb-10">
                 {/* Sombra refor√ßada (shadow-xl + shadow-glow) e drop-shadow na imagem */}
                 <div className="w-24 h-24 bg-white rounded-3xl shadow-logo-glow animate-pulse-glow flex items-center justify-center mb-6 p-4 transform transition-transform hover:scale-105 duration-500">
                    <img src="https://i.imgur.com/ae2m1Bk.png" className="w-full h-full object-contain drop-shadow-sm" alt="HSM"/>
                 </div>
                 <h1 className="text-2xl font-heading font-bold text-slate-800 text-center">Bem-vindo ao <span className="text-hsm-blue">BSSM</span></h1>
                 <p className="text-sm text-slate-500 font-medium mt-2">Benef√≠cio Sa√∫de Santa Marta</p>
               </div>

               <form onSubmit={handleSubmit} className="space-y-5">
                 {error && (
                   <div className="bg-rose-50 border border-rose-100 text-rose-600 text-xs font-bold p-4 rounded-2xl flex items-center gap-3 animate-fade-in">
                     <AlertCircle size={18} className="shrink-0"/>
                     {error}
                   </div>
                 )}
                 
                 <div className="space-y-1.5">
                   <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wider ml-1">Identifica√ß√£o</label>
                   <div className="relative group">
                     <div className="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 group-focus-within:text-hsm-blue transition-colors">
                       <UserCheck size={20}/>
                     </div>
                     <input 
                       type="text" 
                       value={id} 
                       onChange={handleChange} 
                       className="block w-full pl-12 pr-4 py-4 bg-slate-50 border-2 border-transparent text-slate-800 font-bold rounded-2xl focus:bg-white focus:border-hsm-blue focus:shadow-glow outline-none transition-all placeholder:text-slate-300 placeholder:font-normal" 
                       placeholder="CPF ou Usu√°rio" 
                       required
                     />
                   </div>
                 </div>

                 <div className="space-y-1.5">
                   <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wider ml-1">Senha de Acesso</label>
                   <div className="relative group">
                     <div className="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 group-focus-within:text-hsm-blue transition-colors">
                       <Lock size={20}/>
                     </div>
                     <input 
                       type="password" 
                       value={pass} 
                       onChange={e => setPass(e.target.value)} 
                       className="block w-full pl-12 pr-4 py-4 bg-slate-50 border-2 border-transparent text-slate-800 font-bold rounded-2xl focus:bg-white focus:border-hsm-blue focus:shadow-glow outline-none transition-all placeholder:text-slate-300 placeholder:font-normal" 
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                       required
                     />
                   </div>
                 </div>

                 <button 
                   type="submit" 
                   disabled={loading} 
                   className="w-full bg-gradient-to-r from-hsm-blue to-hsm-dark hover:brightness-110 text-white font-bold rounded-2xl text-sm py-4 shadow-lg shadow-hsm-blue/30 transform active:scale-95 transition-all flex justify-center items-center gap-2 mt-4"
                 >
                   {loading ? (
                     <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                   ) : (
                     <>ACESSAR PORTAL <ArrowRight size={18}/></>
                   )}
                 </button>
               </form>

               <div className="mt-8 pt-6 border-t border-slate-100 text-center">
                 <p className="text-[10px] text-slate-400 font-medium">Benef√≠cio Sa√∫de Santa Marta ¬© 2026</p>
                 <p className="text-[10px] text-slate-300 mt-1">Acesso seguro e criptografado</p>
               </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const [user, setUser] = useState(null);
        const [dbData, setDbData] = useState([]);
        const [lastUpdated, setLastUpdated] = useState('--');

        useEffect(() => {
          const sess = storageService.getSession();
          if (sess) setUser(sess);
          const db = storageService.getData();
          if (db) { setDbData(db.data); setLastUpdated(db.date); }
        }, []);

        const handleLogin = (newUser) => {
          if (newUser.role === UserRole.USER) {
            const cpfRaw = newUser.id.replace(/\D/g, '');
            const found = dbData.find(d => (d.cpf && d.cpf.replace(/\D/g, '') === cpfRaw) || d.matricula === cpfRaw);
            if (found) { newUser.name = found.nome; newUser.matricula = found.matricula; }
          }
          setUser(newUser); storageService.setSession(newUser);
        };

        const handleLogout = () => { setUser(null); storageService.clearSession(); };
        const handleClear = () => { setDbData([]); setLastUpdated('--'); storageService.clearData(); };
        
        if (!user) return <Login onLogin={handleLogin} />;

        return (
          <div className="min-h-screen flex flex-col bg-slate-50/50">
            <Header user={user} onLogout={handleLogout} />
            <main className="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-10 animate-fade-in">
              {(user.role === UserRole.ADMIN || user.role === UserRole.CONSULTA) ? (
                <AdminPanel 
                  user={user} 
                  data={dbData} 
                  lastUpdated={lastUpdated} 
                  onDataUpdate={(d) => { setDbData(d); setLastUpdated(new Date().toLocaleDateString('pt-BR')); }} 
                  onClearData={handleClear} 
                />
              ) : (
                <div className="flex flex-col items-center">
                  {(() => {
                    const cpfRaw = user.id.replace(/\D/g, '');
                    const found = dbData.find(d => (d.cpf && d.cpf.replace(/\D/g, '') === cpfRaw) || d.matricula === cpfRaw);
                    if (found) return <DigitalId data={found} />;
                    return (
                      <div className="text-center mt-20 p-10 bg-white rounded-[32px] shadow-card border border-white max-w-md animate-scale-in">
                        <div className="w-20 h-20 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-500 shadow-sm">
                          <XCircle size={40} />
                        </div>
                        <h3 className="text-2xl font-heading font-bold text-slate-800">Cadastro n√£o localizado</h3>
                        <p className="text-slate-500 mt-3 leading-relaxed">
                          O CPF <strong>{user.id}</strong> n√£o foi encontrado na base de dados atual. 
                          <br/><span className="text-xs text-slate-400 block mt-2">Por favor, contate o RH.</span>
                        </p>
                      </div>
                    )
                  })()}
                </div>
              )}
            </main>
            <footer className="bg-white border-t border-slate-100 mt-auto py-8">
              <div className="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4 opacity-70">
                <div className="flex items-center gap-3 grayscale hover:grayscale-0 transition-all duration-500">
                  <img src="https://raw.githubusercontent.com/instrutormedeiros/IndicadoresBrigadaHSM/refs/heads/main/assets/LOGO%20HSM.png" className="h-7 w-auto" />
                  <div className="h-4 w-px bg-slate-300"></div>
                  <span className="text-xs font-bold text-slate-600">¬© 2026 Hospital Santa Marta</span>
                </div>
                <p className="text-[10px] text-slate-400 font-medium bg-slate-50 px-3 py-1 rounded-full">BSSM Enterprise v8.11 ‚Ä¢ Secure Build</p>
              </div>
            </footer>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
